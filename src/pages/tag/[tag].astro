---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import TagList from '../../components/TagList.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  // Build ALL posts (including future-dated). Visibility is handled client-side.
  const tagSet = new Set<string>();
  posts.forEach(p => p.data.tags?.forEach(t => tagSet.add(t)));

  return [...tagSet].map(tag => ({
    params: { tag },
    props: {
      tag,
      posts: posts
        .filter(p => p.data.tags?.includes(tag))
        .sort((a, b) => {
        const dateCmp = (b.data.date ?? '').localeCompare(a.data.date ?? '');
        if (dateCmp !== 0) return dateCmp;
        const la = a.data.lang ?? 'en';
        const lb = b.data.lang ?? 'en';
        if (la === lb) return 0;
        return la === 'en' ? -1 : 1;
      }),
    },
  }));
}

const { tag, posts } = Astro.props;
const buildDate = new Date().toISOString().slice(0, 10);

function postHref(post: typeof posts[0]) {
  return '/' + (post.data.wpSlug ?? post.slug) + '/';
}

function formatDate(d?: string) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
}

// Counts for the tag header — published only by default
const publishedCount = posts.filter(p => (p.data.date ?? '1970-01-01') <= buildDate).length;
const scheduledCount = posts.length - publishedCount;
---

<Layout title={`#${tag} — Joseph Bae`} description={`Posts tagged ${tag}`}>
  <div class="tag-header">
    <a href="/" class="back-link">← All posts</a>
    <h1 class="tag-title">#{tag}</h1>
    <p class="tag-count">
      <span id="visible-count">{publishedCount}</span> {publishedCount === 1 ? 'post' : 'posts'}
      {scheduledCount > 0 && (
        <span id="scheduled-hint" style="display:none"> · {scheduledCount} scheduled</span>
      )}
    </p>
  </div>

  <div class="post-list">
    {posts.map(post => {
      const isFuture = (post.data.date ?? '1970-01-01') > buildDate;
      return (
        <a
          href={postHref(post)}
          class="post-item"
          data-lang={post.data.lang ?? 'en'}
          data-future={isFuture ? 'true' : 'false'}
          style={isFuture ? 'display:none' : undefined}
        >
          <span class="post-date">{formatDate(post.data.date)}</span>
          <span class="post-title">{post.data.title}</span>
          <div class="post-right">
            <TagList tags={(post.data.tags ?? []).filter(t => t !== tag)} />
            <span class="post-lang-badge">{(post.data.lang ?? 'en').toUpperCase()}</span>
          </div>
        </a>
      );
    })}
  </div>
</Layout>

<script>
  const STORAGE_KEY = 'baejoseph_preview_mode';
  function isPreview() {
    try { return localStorage.getItem(STORAGE_KEY) === 'true'; } catch { return false; }
  }

  function syncTagPage() {
    const preview = isPreview();
    let visibleCount = 0;
    document.querySelectorAll<HTMLElement>('.post-item').forEach(el => {
      const isFuture = el.dataset.future === 'true';
      const show = !isFuture || preview;
      el.style.display = show ? 'flex' : 'none';
      if (show) visibleCount++;
    });
    const hint = document.getElementById('scheduled-hint');
    if (hint) hint.style.display = preview ? 'inline' : 'none';
    const countEl = document.getElementById('visible-count');
    if (countEl) countEl.textContent = String(visibleCount);
  }

  document.addEventListener('previewModeChanged', syncTagPage);
  document.addEventListener('DOMContentLoaded', syncTagPage);
</script>

<style>
  .tag-header {
    margin-bottom: 2.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
  }
  .tag-title {
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: -0.03em;
    color: var(--accent);
    margin: 0.75rem 0 0.25rem;
  }
  .tag-count {
    color: var(--text-muted);
    font-size: 0.9rem;
  }
  .post-list {
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  .post-item {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 0.9rem 0;
    border-bottom: 1px solid var(--border);
    text-decoration: none;
    color: inherit;
  }
  .post-item:hover .post-title { color: var(--accent-hover); }
  .post-date {
    color: var(--text-muted);
    font-size: 0.8rem;
    white-space: nowrap;
    min-width: 90px;
    font-variant-numeric: tabular-nums;
  }
  .post-title {
    font-size: 1rem;
    font-weight: 500;
    color: var(--text);
    transition: color 0.15s;
    line-height: 1.4;
    flex: 1;
  }
  .post-right {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-left: auto;
    flex-shrink: 0;
  }
  .post-lang-badge {
    font-size: 0.7rem;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text-muted);
    white-space: nowrap;
  }

  @media (max-width: 640px) {
    .post-item { flex-wrap: wrap; gap: 0.25rem; }
    .post-date { min-width: auto; }
    .post-right { margin-left: 0; }
  }
</style>
